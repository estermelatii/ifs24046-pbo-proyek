<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Analisis Statistik - WishTrack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #f8fafc; font-family: 'Plus Jakarta Sans', sans-serif;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E"), radial-gradient(at 0% 0%, #f1f5f9 0px, transparent 50%), radial-gradient(at 100% 0%, #3b82f6 0px, transparent 50%);
            background-size: auto, cover; background-attachment: fixed; min-height: 100vh;
        }
        .stat-card-container { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); border: 1px solid white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); padding: 30px; height: 100%; }
        .chart-box { position: relative; height: 300px; width: 100%; display: flex; align-items: center; justify-content: center; }
        .navbar { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.5); }
    </style>
</head>
<body>

<nav class="navbar mb-5 sticky-top py-3">
    <div class="container">
        <a class="btn btn-light rounded-pill px-4 shadow-sm fw-bold text-primary" href="/wishlist">Dashboard</a>
        <span class="fw-bold text-dark fs-5">Analisis Keuangan</span>
    </div>
</nav>

<div class="container pb-5">
    <div class="row g-4">
        <!-- Chart 1: Donut -->
        <div class="col-lg-4">
            <div class="stat-card-container text-center">
                <h5 class="fw-bold text-secondary mb-4">Status Barang</h5>
                <div class="chart-box" style="height: 250px;">
                    <canvas id="doughnutChart"></canvas>
                </div>
                <div class="mt-4 d-flex justify-content-center gap-4">
                    <div class="text-success fw-bold"><span th:text="${stats.totalPurchased}">0</span> Terbeli</div>
                    <div class="text-warning fw-bold"><span th:text="${stats.totalWishlist}">0</span> Rencana</div>
                </div>
            </div>
        </div>

        <!-- Chart 2: Bar (Kategori) -->
        <div class="col-lg-8">
            <div class="stat-card-container">
                <h4 class="fw-bold text-dark mb-4">Anggaran per Kategori</h4>
                <div class="chart-box">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Chart 3: Line (Harga) -->
        <div class="col-12">
            <div class="stat-card-container">
                <h4 class="fw-bold text-dark mb-4">Fluktuasi Harga Wishlist</h4>
                <div class="chart-box">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // 1. DONUT
    var bought = /*[[${stats.totalPurchased}]]*/ 0;
    var pending = /*[[${stats.totalWishlist}]]*/ 0;
    new Chart(document.getElementById('doughnutChart'), {
        type: 'doughnut',
        data: { labels: ['Dibeli', 'Rencana'], datasets: [{ data: [bought, pending], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }] },
        options: { cutout: '70%', plugins: { legend: { display: false } } }
    });

    // DATA ITEM
    var names = []; var prices = []; var categories = [];
    /*[# th:each="item : ${items}"]*/
        names.push(/*[[${item.name}]]*/ ''); prices.push(/*[[${item.price}]]*/ 0); categories.push(/*[[${item.category}]]*/ '');
    /*[/]*/

    // 2. BAR CHART (Group by Category)
    var catTotals = {};
    for(var i=0; i<categories.length; i++) {
        var c = categories[i]; var p = prices[i] || 0;
        catTotals[c] = (catTotals[c] || 0) + p;
    }
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: { 
            labels: Object.keys(catTotals), 
            datasets: [{ label: 'Total', data: Object.values(catTotals), backgroundColor: ['#3b82f6', '#ef4444', '#f59e0b', '#10b981', '#8b5cf6'], borderRadius: 8 }] 
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // 3. LINE CHART
    var ctxLine = document.getElementById('lineChart').getContext('2d');
    var grad = ctxLine.createLinearGradient(0,0,0,400);
    grad.addColorStop(0, 'rgba(59,130,246,0.5)'); grad.addColorStop(1, 'rgba(59,130,246,0)');
    new Chart(ctxLine, {
        type: 'line',
        data: { 
            labels: names, 
            datasets: [{ label: 'Harga', data: prices, borderColor: '#3b82f6', backgroundColor: grad, fill: true, tension: 0.4 }] 
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
    /*]]>*/
</script>
</body>
</html>